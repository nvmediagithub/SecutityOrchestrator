package org.example.infrastructure.services.testgen;

import org.example.domain.entities.TestScenario;
import org.example.domain.entities.TestStep;
import org.example.domain.valueobjects.OwaspTestCategory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.util.*;

/**
 * Построитель промптов для LLM генерации OWASP тестовых сценариев
 */
@Service
public class OwaspTestLLMBuilder {
    
    private static final Logger logger = LoggerFactory.getLogger(OwaspTestLLMBuilder.class);
    
    private static final String SYSTEM_PROMPT = """
        You are an expert security testing engineer specializing in OWASP API Security Top 10 2019.
        Generate comprehensive, executable test scenarios based on API analysis and BPMN process data.
        """;

    public String buildScenarioGenerationPrompt(
            OwaspTestCategory category,
            Map<String, Object> openApiAnalysis,
            Map<String, Object> bpmnAnalysis,
            int scenarioCount) {
        
        StringBuilder prompt = new StringBuilder();
        prompt.append(SYSTEM_PROMPT).append("\n\n");
        
        prompt.append("OWASP Category: ").append(category.getCategoryCode())
              .append(" - ").append(category.getCategoryName())
              .append("\nDescription: ").append(category.getDescription())
              .append("\nTest Types: ").append(String.join(", ", category.getTestTypes()))
              .append("\n\n");
        
        if (openApiAnalysis != null && !openApiAnalysis.isEmpty()) {
            prompt.append("OpenAPI Analysis Context:\n");
            prompt.append("Available API endpoints and structure\n\n");
        }
        
        if (bpmnAnalysis != null && !bpmnAnalysis.isEmpty()) {
            prompt.append("BPMN Process Analysis Context:\n");
            prompt.append("Process flows and business logic\n\n");
        }
        
        prompt.append("Generate ").append(scenarioCount).append(" test scenarios.\n\n");
        
        prompt.append(buildResponseFormatInstructions(scenarioCount));
        
        return prompt.toString();
    }
    
    public String buildIssueBasedScenarioPrompt(
            OwaspTestCategory category,
            Map<String, Object> issueDetails,
            String analysisId) {
        
        StringBuilder prompt = new StringBuilder();
        prompt.append(SYSTEM_PROMPT).append("\n\n");
        
        prompt.append("Generate a targeted test scenario for a specific security issue:\n\n");
        
        prompt.append("Issue Details:\n");
        for (Map.Entry<String, Object> entry : issueDetails.entrySet()) {
            prompt.append("- ").append(entry.getKey()).append(": ").append(entry.getValue()).append("\n");
        }
        
        prompt.append("\nOWASP Category: ").append(category.getCategoryCode())
              .append(" - ").append(category.getCategoryName())
              .append("\n\n");
        
        prompt.append("Create a specific test scenario that directly tests the identified vulnerability.\n\n");
        prompt.append(buildResponseFormatInstructions(1));
        
        return prompt.toString();
    }
    
    private String buildResponseFormatInstructions(int scenarioCount) {
        return String.format("""
            Generate %d test scenarios in JSON format with:
            - name: Descriptive test name
            - description: Clear description
            - objective: Security objective
            - testSteps: Array of test steps
            - preconditions: Required conditions
            - expectedResults: Expected outcomes
            - testData: Required data
            - severity: LOW|MEDIUM|HIGH|CRITICAL
            """, scenarioCount);
    }
}