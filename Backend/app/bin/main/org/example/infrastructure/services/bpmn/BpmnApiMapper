package org.example.infrastructure.services.bpmn;

import org.springframework.stereotype.Service;

/**
 * Маппер BPMN элементов на API эндпоинты
 */
@Service
public class BpmnApiMapper {
    
    /**
     * Создает маппинг между BPMN элементами и API
     */
    public BpmnApiMapping createMapping(String processId, String bpmnElementId, String bpmnElementName, 
                                       String bpmnElementType, String apiEndpoint, String httpMethod) {
        return org.example.domain.entities.BpmnApiMapping.createMapping(
            null, // BpmnProcessId will be created from processId
            bpmnElementId, bpmnElementName, bpmnElementType, 
            apiEndpoint, httpMethod
        );
    }
    
    /**
     * Создает маппинг с описанием
     */
    public BpmnApiMapping createMappingWithDescription(String processId, String bpmnElementId, 
                                                       String bpmnElementName, String bpmnElementType,
                                                       String apiEndpoint, String httpMethod, 
                                                       String mappingDescription) {
        return org.example.domain.entities.BpmnApiMapping.createMappingWithDescription(
            null, // BpmnProcessId will be created from processId
            bpmnElementId, bpmnElementName, bpmnElementType,
            apiEndpoint, httpMethod, mappingDescription
        );
    }
    
    /**
     * Анализирует BPMN процесс и предлагает API маппинги
     */
    public java.util.List<BpmnApiMapping> suggestApiMappings(BpmnParsedData parsedData) {
        java.util.List<BpmnApiMapping> mappings = new java.util.ArrayList<>();
        
        for (BpmnElement element : parsedData.getElements()) {
            if (element.isTask()) {
                String suggestedEndpoint = suggestEndpointForTask(element);
                String suggestedMethod = suggestHttpMethodForTask(element);
                
                BpmnApiMapping mapping = createMapping(
                    parsedData.getProcessId(),
                    element.getId(),
                    element.getName(),
                    element.getType(),
                    suggestedEndpoint,
                    suggestedMethod
                );
                mappings.add(mapping);
            }
        }
        
        return mappings;
    }
    
    private String suggestEndpointForTask(BpmnElement element) {
        String elementName = element.getName().toLowerCase().replaceAll("\\s+", "-");
        
        if (elementName.contains("create") || elementName.contains("добав")) {
            return "/" + elementName;
        } else if (elementName.contains("update") || elementName.contains("обнов")) {
            return "/" + elementName + "/{id}";
        } else if (elementName.contains("delete") || elementName.contains("уда")) {
            return "/" + elementName + "/{id}";
        } else if (elementName.contains("list") || elementName.contains("список")) {
            return "/" + elementName;
        } else {
            return "/" + elementName;
        }
    }
    
    private String suggestHttpMethodForTask(BpmnElement element) {
        String elementName = element.getName().toLowerCase();
        
        if (elementName.contains("create") || elementName.contains("добав") || 
            elementName.contains("submit") || elementName.contains("отправ")) {
            return "POST";
        } else if (elementName.contains("update") || elementName.contains("обнов")) {
            return "PUT";
        } else if (elementName.contains("delete") || elementName.contains("уда")) {
            return "DELETE";
        } else if (elementName.contains("get") || elementName.contains("получ") ||
                   elementName.contains("list") || elementName.contains("список")) {
            return "GET";
        } else {
            return "POST"; // По умолчанию
        }
    }
}