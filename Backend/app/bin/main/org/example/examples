package org.example.examples.openapi;

import org.example.infrastructure.services.openapi.*;
import org.example.domain.entities.openapi.OpenApiSpecification;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Optional;

/**
 * Примеры использования OpenAPI парсера и утилит
 * Демонстрирует основные возможности системы
 */
@Component
public class OpenApiUsageExamples {
    
    @Autowired
    private OpenApiOrchestrationService orchestrationService;
    
    @Autowired
    private OpenApiParserService parserService;
    
    @Autowired
    private OpenApiValidator validator;
    
    @Autowired
    private OpenApiDataExtractor dataExtractor;
    
    @Autowired
    private OpenApiChunker chunker;
    
    @Autowired
    private OpenApiIssueDetector issueDetector;
    
    /**
     * Пример 1: Полный анализ OpenAPI спецификации
     */
    public void exampleFullAnalysis() {
        String openApiSpec = """
            openapi: 3.0.3
            info:
              title: Pet Store API
              version: 1.0.0
            paths:
              /pets:
                get:
                  summary: List all pets
                  operationId: listPets
                  tags:
                    - pets
                  parameters:
                    - name: limit
                      in: query
                      description: How many items to return at one time (max 100)
                      required: false
                      schema:
                        type: integer
                        format: int32
                  responses:
                    '200':
                      description: A paged array of pets
                      content:
                        application/json:
                          schema:
                            $ref: "#/components/schemas/Pets"
            components:
              schemas:
                Pet:
                  type: object
                  required:
                    - id
                    - name
                  properties:
                    id:
                      type: integer
                      format: int64
                    name:
                      type: string
                    tag:
                      type: string
                Pets:
                  type: array
                  items:
                    $ref: "#/components/schemas/Pet"
            """;
        
        // Полный анализ с использованием оркестрационного сервиса
        OpenApiOrchestrationService.OpenApiAnalysisResult result = 
            orchestrationService.analyzeSpecification(openApiSpec, "yaml");
        
        if (result.getStatus() == OpenApiAnalysisResult.AnalysisStatus.COMPLETED) {
            System.out.println("Анализ завершен успешно!");
            System.out.println("Найдено эндпоинтов: " + 
                result.getSpecification().getEndpoints().size());
            System.out.println("Найдено схем: " + 
                result.getSpecification().getSchemas().size());
            System.out.println("Ошибок валидации: " + 
                result.getValidationResult().getErrorCount());
            System.out.println("Проблем: " + 
                result.getIssueReport().getTotalIssues());
        } else {
            System.out.println("Ошибка анализа: " + result.getErrorMessage());
        }
    }
    
    /**
     * Пример 2: Парсинг и валидация спецификации
     */
    public void exampleParseAndValidate() {
        String jsonSpec = """
            {
              "openapi": "3.0.3",
              "info": {
                "title": "User API",
                "version": "2.0.0"
              },
              "paths": {
                "/users/{id}": {
                  "get": {
                    "summary": "Get user by ID",
                    "parameters": [
                      {
                        "name": "id",
                        "in": "path",
                        "required": true,
                        "schema": {
                          "type": "string"
                        }
                      }
                    ]
                  }
                }
              }
            }
            """;
        
        try {
            // Парсинг
            OpenApiSpecification specification = parserService.parseSpecification(jsonSpec, "json");
            System.out.println("Спецификация успешно распарсена!");
            System.out.println("Заголовок: " + specification.getTitle());
            System.out.println("Версия: " + specification.getOpenApiVersion());
            
            // Валидация
            OpenApiValidator.ValidationResult validationResult = validator.validateSpecification(specification);
            if (validationResult.isValid()) {
                System.out.println("Спецификация валидна!");
            } else {
                System.out.println("Найдены ошибки валидации:");
                for (String error : validationResult.getErrors()) {
                    System.out.println("- " + error);
                }
            }
            
        } catch (OpenApiParserService.OpenApiParsingException e) {
            System.out.println("Ошибка парсинга: " + e.getMessage());
        }
    }
    
    /**
     * Пример 3: Извлечение данных для LLM
     */
    public void exampleLLMDataExtraction() {
        String specContent = """
            openapi: 3.0.0
            info:
              title: E-commerce API
              version: 1.0.0
            paths:
              /products:
                get:
                  summary: Get all products
                  tags: [products]
              /orders:
                post:
                  summary: Create order
                  tags: [orders]
            """;
        
        try {
            OpenApiSpecification specification = parserService.parseSpecification(specContent, "yaml");
            
            // Подготовка данных для LLM
            OpenApiDataExtractor.OpenApiLLMData llmData = dataExtractor.prepareForLLMAnalysis(specification);
            
            System.out.println("Данные для LLM подготовлены:");
            System.out.println("Эндпоинтов: " + llmData.getEndpoints().size());
            System.out.println("Схем: " + llmData.getSchemas().size());
            
            // Генерация краткого описания
            String summary = dataExtractor.generateSummary(specification);
            System.out.println("\nКраткое описание API:");
            System.out.println(summary);
            
        } catch (Exception e) {
            System.out.println("Ошибка: " + e.getMessage());
        }
    }
    
    /**
     * Пример 4: Разбивка большой спецификации на части
     */
    public void exampleChunking() {
        // Создаем большую спецификацию для демонстрации
        StringBuilder largeSpec = new StringBuilder();
        largeSpec.append("openapi: 3.0.3\n")
                 .append("info:\n")
                 .append("  title: Large API\n")
                 .append("  version: 1.0.0\n")
                 .append("paths:\n");
        
        // Добавляем много эндпоинтов
        for (int i = 1; i <= 50; i++) {
            largeSpec.append("  /endpoint").append(i).append(":\n")
                     .append("    get:\n")
                     .append("      summary: Endpoint ").append(i).append("\n")
                     .append("      description: This is endpoint number ").append(i).append(" with a very long description to demonstrate chunking capabilities\n");
        }
        
        largeSpec.append("components:\n  schemas:\n");
        
        // Добавляем много схем
        for (int i = 1; i <= 30; i++) {
            largeSpec.append("    Schema").append(i).append(":\n")
                     .append("      type: object\n")
                     .append("      description: This is schema number ").append(i).append(" with detailed properties\n")
                     .append("      properties:\n")
                     .append("        id:\n")
                     .append("          type: integer\n")
                     .append("        name:\n")
                     .append("          type: string\n");
        }
        
        try {
            OpenApiSpecification specification = parserService.parseSpecification(
                largeSpec.toString(), "yaml");
            
            // Разбивка на чанки
            List<OpenApiChunker.OpenApiChunk> chunks = chunker.chunkSpecification(specification, 5000);
            
            System.out.println("Спецификация разбита на " + chunks.size() + " частей:");
            for (OpenApiChunker.OpenApiChunk chunk : chunks) {
                System.out.println("- " + chunk.getFullTitle() + 
                    " (размер: " + chunk.getSize() + " символов)");
            }
            
        } catch (Exception e) {
            System.out.println("Ошибка: " + e.getMessage());
        }
    }
    
    /**
     * Пример 5: Анализ проблем в спецификации
     */
    public void exampleIssueDetection() {
        String problematicSpec = """
            openapi: 2.0
            info:
              title: Problematic API
              version: 1.0.0
            paths:
              /users:
                get:
                  summary: ""
                  description: ""
                post:
                  summary: Create user
                  parameters:
                    - name: id
                      in: path
                      required: false
              /admin:
                get:
                  summary: Admin access
            """;
        
        try {
            OpenApiSpecification specification = parserService.parseSpecification(problematicSpec, "yaml");
            
            // Анализ проблем
            OpenApiIssueDetector.OpenApiIssueReport report = issueDetector.detectIssues(specification);
            
            System.out.println("Отчет о проблемах:");
            System.out.println("Всего проблем: " + report.getTotalIssues());
            System.out.println("Ошибок: " + report.getErrorCount());
            System.out.println("Предупреждений: " + report.getWarningCount());
            
            // Показываем детали проблем
            for (OpenApiIssueDetector.OpenApiIssue issue : report.getIssues()) {
                System.out.println("- [" + issue.getSeverity() + "] " + 
                    issue.getTitle() + ": " + issue.getDescription());
            }
            
        } catch (Exception e) {
            System.out.println("Ошибка: " + e.getMessage());
        }
    }
    
    /**
     * Пример 6: Работа с базой данных
     */
    public void exampleDatabaseOperations() {
        String specToSave = """
            openapi: 3.0.3
            info:
              title: API для сохранения
              version: 1.0.0
            paths:
              /test:
                get:
                  summary: Test endpoint
            """;
        
        try {
            // Парсинг
            OpenApiSpecification specification = parserService.parseSpecification(specToSave, "yaml");
            
            // Сохранение в базу
            String specId = orchestrationService.saveSpecification(specification);
            System.out.println("Спецификация сохранена с ID: " + specId);
            
            // Получение из базы
            Optional<OpenApiSpecification> retrievedSpec = orchestrationService.getSpecification(specId);
            if (retrievedSpec.isPresent()) {
                System.out.println("Спецификация успешно извлечена из базы");
                System.out.println("Заголовок: " + retrievedSpec.get().getTitle());
            }
            
            // Анализ сохраненной спецификации
            OpenApiOrchestrationService.OpenApiAnalysisResult result = 
                orchestrationService.analyzeSavedSpecification(specId);
            System.out.println("Анализ сохраненной спецификации завершен");
            
        } catch (Exception e) {
            System.out.println("Ошибка: " + e.getMessage());
        }
    }
    
    /**
     * Пример 7: Загрузка из файла
     */
    public void exampleFileUpload() {
        // В реальном приложении файл приходит от пользователя
        // org.springframework.web.multipart.MultipartFile file = ...;
        
        // OpenApiOrchestrationService.OpenApiAnalysisResult result = 
        //     orchestrationService.analyzeSpecificationFromFile(file);
        
        System.out.println("Пример загрузки файла спецификации");
        System.out.println("В реальном приложении используйте:");
        System.out.println("OpenApiOrchestrationService.OpenApiAnalysisResult result = ");
        System.out.println("    orchestrationService.analyzeSpecificationFromFile(file);");
    }
    
    /**
     * Пример 8: Загрузка по URL
     */
    public void exampleUrlLoading() {
        String specUrl = "https://petstore3.swagger.io/api/v3/openapi.json";
        
        OpenApiOrchestrationService.OpenApiAnalysisResult result = 
            orchestrationService.analyzeSpecificationFromUrl(specUrl);
        
        if (result.getStatus() == OpenApiAnalysisResult.AnalysisStatus.COMPLETED) {
            System.out.println("Спецификация успешно загружена и проанализирована");
        } else {
            System.out.println("Ошибка загрузки: " + result.getErrorMessage());
        }
    }
    
    /**
     * Основной метод для запуска всех примеров
     */
    public void runAllExamples() {
        System.out.println("=== Примеры использования OpenAPI системы ===\n");
        
        try {
            exampleFullAnalysis();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleParseAndValidate();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleLLMDataExtraction();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleChunking();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleIssueDetection();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleDatabaseOperations();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleFileUpload();
            System.out.println("\n" + "=".repeat(50) + "\n");
            
            exampleUrlLoading();
            
        } catch (Exception e) {
            System.out.println("Ошибка выполнения примеров: " + e.getMessage());
            e.printStackTrace();
        }
    }
}