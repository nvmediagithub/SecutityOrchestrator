package org.example.infrastructure.services;

import org.example.domain.dto.test.ApiResponse;
import org.example.domain.entities.TestProject;
import org.example.infrastructure.repositories.TestProjectRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

/**
 * Service for managing test projects
 */
@Service
@Transactional
public class ProjectService {
    
    private final TestProjectRepository testProjectRepository;
    
    public ProjectService(TestProjectRepository testProjectRepository) {
        this.testProjectRepository = testProjectRepository;
    }
    
    /**
     * Get all projects
     */
    @Transactional(readOnly = true)
    public ApiResponse<List<TestProject>> getAllProjects() {
        try {
            List<TestProject> projects = testProjectRepository.findAllByOrderByCreatedAtDesc();
            return ApiResponse.success(projects);
        } catch (Exception e) {
            return ApiResponse.error("Failed to fetch projects: " + e.getMessage());
        }
    }
    
    /**
     * Get project by ID
     */
    @Transactional(readOnly = true)
    public ApiResponse<TestProject> getProjectById(Long id) {
        try {
            Optional<TestProject> projectOpt = testProjectRepository.findById(id);
            if (projectOpt.isEmpty()) {
                return ApiResponse.error("Project not found");
            }
            return ApiResponse.success(projectOpt.get());
        } catch (Exception e) {
            return ApiResponse.error("Failed to fetch project: " + e.getMessage());
        }
    }
    
    /**
     * Get project by project ID
     */
    @Transactional(readOnly = true)
    public ApiResponse<TestProject> getProjectByProjectId(String projectId) {
        try {
            Optional<TestProject> projectOpt = testProjectRepository.findByProjectId(projectId);
            if (projectOpt.isEmpty()) {
                return ApiResponse.error("Project not found");
            }
            return ApiResponse.success(projectOpt.get());
        } catch (Exception e) {
            return ApiResponse.error("Failed to fetch project: " + e.getMessage());
        }
    }
    
    /**
     * Create new project
     */
    public ApiResponse<TestProject> createProject(TestProject project) {
        try {
            TestProject savedProject = testProjectRepository.save(project);
            return ApiResponse.success("Project created successfully", savedProject);
        } catch (Exception e) {
            return ApiResponse.error("Failed to create project: " + e.getMessage());
        }
    }
    
    /**
     * Update project
     */
    public ApiResponse<TestProject> updateProject(Long id, TestProject project) {
        try {
            Optional<TestProject> existingOpt = testProjectRepository.findById(id);
            if (existingOpt.isEmpty()) {
                return ApiResponse.error("Project not found");
            }
            
            project.setId(id);
            TestProject savedProject = testProjectRepository.save(project);
            return ApiResponse.success("Project updated successfully", savedProject);
        } catch (Exception e) {
            return ApiResponse.error("Failed to update project: " + e.getMessage());
        }
    }
    
    /**
     * Delete project
     */
    public ApiResponse<String> deleteProject(Long id) {
        try {
            Optional<TestProject> projectOpt = testProjectRepository.findById(id);
            if (projectOpt.isEmpty()) {
                return ApiResponse.error("Project not found");
            }
            
            testProjectRepository.deleteById(id);
            return ApiResponse.success("Project deleted successfully");
        } catch (Exception e) {
            return ApiResponse.error("Failed to delete project: " + e.getMessage());
        }
    }
}