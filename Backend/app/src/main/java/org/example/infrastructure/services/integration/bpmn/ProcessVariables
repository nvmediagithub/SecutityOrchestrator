package org.example.infrastructure.services.integration.bpmn;

import org.example.domain.dto.integration.BpmnContextExtractionRequest;
import org.example.domain.entities.BpmnDiagram;
import org.example.infrastructure.services.bpmn.BpmnAnalysisService;
import org.example.infrastructure.services.integration.llm.LlmAnalysisService;
import org.example.infrastructure.services.integration.status.ExtractionStatusService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executor;

/**
 * Specialized extractor for BPMN process variables
 * Focuses solely on extracting and analyzing process variables from BPMN diagrams
 */
@Service
public class ProcessVariablesExtractor {
    
    private static final Logger logger = LoggerFactory.getLogger(ProcessVariablesExtractor.class);
    
    @Autowired
    private BpmnAnalysisService bpmnAnalysisService;
    
    @Autowired
    private LlmAnalysisService llmAnalysisService;
    
    @Autowired
    private ExtractionStatusService statusService;
    
    @Autowired
    private Executor bpmnExtractionExecutor;
    
    /**
     * Extracts process variables from BPMN diagram
     */
    @Async
    public CompletableFuture<BpmnContextOrchestrator.PartialExtractionResult> extract(
            BpmnContextExtractionRequest request, String extractionId) {
        
        logger.info("Starting process variables extraction for diagram: {}, extractionId: {}", 
                   request.getDiagramId(), extractionId);
        
        return CompletableFuture.supplyAsync(() -> {
            try {
                statusService.updateExtractionStatus(extractionId, "PROCESS_VARIABLES_EXTRACTION");
                
                BpmnDiagram diagram = createBpmnDiagram(request);
                
                BpmnAnalysisService.BpmnAnalysisResult analysisResult = analyzeBpmnDiagram(diagram);
                
                String prompt = buildProcessVariablesPrompt(diagram, analysisResult);
                
                String llmResponse = llmAnalysisService.executeAnalysis(prompt, "process_variables");
                
                Map<String, Object> variablesData = parseVariablesResponse(llmResponse);
                
                BpmnContextOrchestrator.PartialExtractionResult result = new BpmnContextOrchestrator.PartialExtractionResult();
                result.setExtractionType("PROCESS_VARIABLES");
                result.setVariablesData(variablesData);
                result.setProcessingTimeMs(System.currentTimeMillis() - extractionId.hashCode());
                result.setTimestamp(LocalDateTime.now());
                
                logger.info("Process variables extraction completed for diagram: {}", request.getDiagramId());
                return result;
                
            } catch (Exception e) {
                logger.error("Process variables extraction failed for diagram: {}", request.getDiagramId(), e);
                throw new RuntimeException("Process variables extraction failed", e);
            }
        }, bpmnExtractionExecutor);
    }
    
    /**
     * Analyzes BPMN diagram to get base information
     */
    private BpmnAnalysisService.BpmnAnalysisResult analyzeBpmnDiagram(BpmnDiagram diagram) {
        try {
            return bpmnAnalysisService.analyzeBpmnDiagram(diagram.getDiagramId(), diagram).get();
        } catch (Exception e) {
            logger.warn("BPMN analysis failed, proceeding with basic analysis", e);
            return null;
        }
    }
    
    /**
     * Creates BPMN diagram from request
     */
    private BpmnDiagram createBpmnDiagram(BpmnContextExtractionRequest request) {
        BpmnDiagram diagram = new BpmnDiagram();
        diagram.setDiagramId(request.getDiagramId());
        diagram.setBpmnContent(request.getBpmnContent());
        diagram.setCreatedAt(LocalDateTime.now());
        return diagram;
    }
    
    /**
     * Builds LLM prompt for process variables extraction
     */
    private String buildProcessVariablesPrompt(BpmnDiagram diagram, 
                                             BpmnAnalysisService.BpmnAnalysisResult analysisResult) {
        return String.format("""
            Извлеки переменные процесса из данной BPMN диаграммы:

            1. Переменные процесса (Process Variables):
               - Имена переменных
               - Типы данных
               - Область видимости (PROCESS, TASK, GLOBAL)
               - Обязательность

            2. Источники данных (Data Sources):
               - Пользовательский ввод
               - Системные данные
               - Внешние системы
               - Вычисляемые значения

            3. Валидационные правила (Validation Rules):
               - Правила для переменных
               - Ограничения значений
               - Форматы данных

            BPMN Диаграмма: %s
            Результаты анализа: %s

            Ответь в формате JSON со структурой:
            {
              "processVariables": [...],
              "dataSources": [...],
              "validationRules": [...]
            }
            """, diagram.getBpmnContent(), 
            analysisResult != null ? analysisResult.toString() : "N/A");
    }
    
    /**
     * Parses LLM response for variables data
     */
    private Map<String, Object> parseVariablesResponse(String llmResponse) {
        Map<String, Object> result = new HashMap<>();
        result.put("rawResponse", llmResponse);
        result.put("parsed", true);
        result.put("extractionType", "PROCESS_VARIABLES");
        result.put("extractionTime", LocalDateTime.now().toString());
        
        // In a real implementation, you would parse the JSON response
        // For now, we return the raw response with parsing metadata
        return result;
    }
}