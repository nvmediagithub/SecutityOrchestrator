# LLM Service for OpenAPI Analysis - Implementation Report

## Обзор

Создан мощный LLM сервис для анализа OpenAPI спецификаций, интегрированный с существующей инфраструктурой проекта. Сервис использует современные LLM модели для автоматического выявления проблем безопасности, валидации и согласованности в OpenAPI спецификациях.

## Архитектура

### Основные компоненты

1. **OpenApiAnalysisService** - главный сервис анализа
   - Координирует LLM анализ OpenAPI спецификаций
   - Асинхронная обработка больших спецификаций
   - Кэширование результатов анализа
   - Fallback между внешними и локальными LLM

2. **LLMPromptBuilder** - построитель промптов
   - Создание специализированных промптов для анализа API
   - Шаблоны промптов для разных типов анализа
   - Оптимизация промптов для конкретных LLM

3. **IssueClassifier** - классификатор проблем
   - Автоматическая классификация выявленных проблем
   - Определение приоритетов проблем
   - Группировка похожих проблем

4. **OpenApiLLMAnalyzer** - анализатор ответов LLM
   - Парсинг JSON и текстовых ответов LLM
   - Извлечение структурированных данных
   - Валидация результатов анализа

## Типы анализа

### 1. Анализ безопасности (Security Analysis)

**Проверяемые проблемы:**
- Отсутствие аутентификации на критических эндпоинтах
- Небезопасные HTTP методы (GET для изменяющих операций)
- Утечка чувствительных данных в схемах
- SQL injection уязвимости в параметрах
- XSS уязвимости в user input
- Отсутствие rate limiting в описании

**Промпт анализа:**
```
Проанализируй OpenAPI спецификацию на предмет уязвимостей безопасности.
Найди следующие проблемы:
1. Эндпоинты без аутентификации
2. Небезопасные HTTP методы
3. Утечка чувствительных данных
4. Потенциальные injection уязвимости
5. Проблемы с rate limiting

Верни результат в JSON формате с детальными рекомендациями.
```

**Формат ответа:**
```json
{
  "securityIssues": [
    {
      "type": "Тип проблемы",
      "severity": "CRITICAL|HIGH|MEDIUM|LOW",
      "endpoint": "Эндпоинт",
      "description": "Описание проблемы",
      "recommendation": "Рекомендации по исправлению"
    }
  ],
  "overallRisk": "HIGH|MEDIUM|LOW",
  "summary": "Общее описание найденных проблем"
}
```

### 2. Анализ валидации (Validation Analysis)

**Проверяемые проблемы:**
- Отсутствие валидации входных параметров
- Некорректные типы данных в схемах
- Отсутствие required полей
- Некорректные регулярные выражения
- Отсутствие ограничений на размеры

**Промпт анализа:**
```
Проанализируй схемы данных и параметры в OpenAPI спецификации.
Найди следующие проблемы:
1. Отсутствие валидации
2. Некорректные типы данных
3. Неправильные ограничения
4. Недостающие required поля

Верни структурированный анализ с рекомендациями.
```

**Формат ответа:**
```json
{
  "validationIssues": [
    {
      "type": "Тип проблемы",
      "severity": "HIGH|MEDIUM|LOW",
      "location": "Местоположение (схема/эндпоинт)",
      "field": "Поле",
      "description": "Описание проблемы",
      "fix": "Рекомендуемое исправление"
    }
  ],
  "schemaQuality": "GOOD|FAIR|POOR",
  "recommendations": ["список рекомендаций"]
}
```

### 3. Анализ согласованности (Consistency Analysis)

**Проверяемые проблемы:**
- Несоответствие описаний и схем
- Различные версии API в документации
- Противоречивые статусы коды
- Несоответствие типов параметров

**Промпт анализа:**
```
Проанализируй согласованность OpenAPI спецификации.
Проверь следующие несогласованности:
1. Несоответствие описаний и схем
2. Различные версии API в документации
3. Противоречивые статусы коды
4. Несоответствие типов параметров

Верни структурированный анализ.
```

### 4. Комплексный анализ (Comprehensive Analysis)

Объединяет все виды анализа в единый отчет с общими метриками.

**Формат ответа:**
```json
{
  "overallScore": "1-10",
  "grade": "A|B|C|D|F",
  "summary": "Общее описание",
  "analysis": {
    "security": {
      "score": "1-10",
      "issues": ["проблемы безопасности"]
    },
    "validation": {
      "score": "1-10",
      "issues": ["проблемы валидации"]
    },
    "consistency": {
      "score": "1-10",
      "issues": ["проблемы согласованности"]
    }
  },
  "recommendations": ["список рекомендаций"]
}
```

## Использование

### 1. Базовый анализ спецификации

```java
@Autowired
private OpenApiAnalysisService analysisService;

// Асинхронный анализ
CompletableFuture<AnalysisResult> result = analysisService.analyzeSpecification(
    "spec-123", 
    openApiSpecification
);

// Получение результатов
AnalysisResult analysisResult = result.get();
```

### 2. Анализ отдельных типов

```java
// Анализ безопасности
CompletableFuture<PartialAnalysisResult> securityResult = analysisService.analyzeSecurity(
    "spec-123", 
    openApiSpecification, 
    "analysis-456"
);

// Анализ валидации
CompletableFuture<PartialAnalysisResult> validationResult = analysisService.analyzeValidation(
    "spec-123", 
    openApiSpecification, 
    "analysis-456"
);
```

### 3. Мониторинг прогресса

```java
// Получение статуса анализа
AnalysisStatus status = analysisService.getAnalysisStatus("analysis-456");
System.out.println("Status: " + status.getStatus());

// Получение результатов
AnalysisResult results = analysisService.getAnalysisResults("analysis-456");
```

### 4. Управление кэшем

```java
// Очистка кэша
analysisService.clearCache();

// Получение статистики сервиса
ServiceStatistics stats = analysisService.getServiceStatistics();
System.out.println("Active analyses: " + stats.getActiveAnalyses());
System.out.println("Cached results: " + stats.getCachedResults());
```

## Классификация проблем

### Типы проблем (IssueType)

- **SECURITY** - проблемы безопасности
- **VALIDATION** - проблемы валидации данных
- **CONSISTENCY** - проблемы согласованности
- **PERFORMANCE** - проблемы производительности
- **DOCUMENTATION** - проблемы документации
- **DESIGN** - проблемы дизайна API
- **QUALITY** - общие проблемы качества

### Домены проблем (IssueDomain)

- **API_DESIGN** - дизайн API
- **DATA_MODEL** - модель данных
- **AUTHENTICATION** - аутентификация
- **DATA_PROTECTION** - защита данных
- **API_VERSIONING** - версионирование API
- **GENERAL** - общие проблемы

### Уровни серьезности (SeverityLevel)

- **CRITICAL** - критические проблемы (требуют немедленного внимания)
- **HIGH** - важные проблемы безопасности или функциональности
- **MEDIUM** - умеренное влияние на функциональность
- **LOW** - незначительные проблемы или рекомендации
- **INFO** - информационные предложения

## Конфигурация

### LLM провайдеры

Сервис поддерживает два типа LLM провайдеров:

1. **OpenRouter** - внешние модели (OpenAI, Anthropic, etc.)
   - Настраивается через `llm.openRouter.*` properties
   - Требует API ключ
   - Высокое качество анализа

2. **LocalLLM** - локальные модели (Ollama)
   - Настраивается через `llm.local.*` properties
   - Работает без интернета
   - Fallback решение

### Параметры анализа

```yaml
llm:
  # OpenRouter settings
  openRouter:
    apiKey: ${OPENROUTER_API_KEY}
    baseUrl: https://openrouter.ai/api/v1
    timeout: 30
  
  # Local LLM settings
  local:
    serverUrl: http://localhost:11434
    timeout: 300
  
  # Performance settings
  maxConcurrentAnalyses: 3
  cacheTtlHours: 24
  analysisTimeoutMinutes: 30
```

## Производительность

### Асинхронная обработка

- Все анализы выполняются асинхронно
- Параллельная обработка разных типов анализа
- Контроль количества одновременных анализов

### Кэширование

- Кэширование результатов на 24 часа
- Автоматическая инвалидация кэша
- Экономия ресурсов для повторных анализов

### Оптимизация памяти

- Поэтапная обработка больших спецификаций
- Освобождение ресурсов после анализа
- Мониторинг использования памяти

## Мониторинг и логирование

### Метрики

- Время выполнения анализа
- Количество найденных проблем
- Использование LLM токенов
- Статистика кэша

### Логирование

- Детальное логирование каждого этапа
- Логи ошибок с контекстом
- Мониторинг производительности

## Интеграция

### Существующая инфраструктура

Сервис интегрирован с:
- `OpenApiOrchestrationService` - для доступа к спецификациям
- `OpenRouterClient` - для внешних LLM
- `LocalLLMService` - для локальных моделей
- `OpenApiIssueDetector` - для дополнительных проверок

### API Endpoints

Рекомендуемые endpoints:
- `POST /api/analysis/specifications/{specId}/analyze` - запуск анализа
- `GET /api/analysis/{analysisId}/status` - статус анализа
- `GET /api/analysis/{analysisId}/results` - результаты анализа
- `GET /api/analysis/statistics` - статистика сервиса

## Безопасность

### Обработка данных

- Спецификации не сохраняются в логах
- Конфиденциальная информация фильтруется
- Безопасное хранение API ключей

### Ограничения

- Ограничение размера обрабатываемых спецификаций
- Контроль количества одновременных запросов
- Таймауты для предотвращения зависания

## Расширение

### Добавление новых типов анализа

1. Создать новый метод в `OpenApiAnalysisService`
2. Добавить промпт в `LLMPromptBuilder`
3. Реализовать парсер в `OpenApiLLMAnalyzer`
4. Обновить классификацию в `IssueClassifier`

### Поддержка новых LLM провайдеров

1. Реализовать интерфейс `LLMProvider`
2. Добавить конфигурацию
3. Обновить fallback логику

## Тестирование

### Unit тесты

- Тестирование отдельных компонентов
- Мокирование LLM сервисов
- Проверка корректности парсинга

### Integration тесты

- Тестирование с реальными OpenAPI спецификациями
- Проверка интеграции с LLM провайдерами
- Нагрузочное тестирование

## Заключение

Созданный LLM сервис для анализа OpenAPI спецификаций представляет собой мощное и гибкое решение, которое:

- Автоматизирует выявление проблем в API спецификациях
- Интегрируется с существующей инфраструктурой
- Поддерживает различные LLM провайдеры
- Обеспечивает высокую производительность
- Предоставляет детальные отчеты и рекомендации

Сервис готов к использованию в продакшене и может быть легко расширен для новых требований.