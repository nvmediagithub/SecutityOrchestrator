import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:security_orchestrator_frontend/data/services/testing_service.dart';

class QuickSecurityScanScreen extends ConsumerStatefulWidget {
  const QuickSecurityScanScreen({super.key});

  @override
  ConsumerState<QuickSecurityScanScreen> createState() => _QuickSecurityScanScreenState();
}

class _QuickSecurityScanScreenState extends ConsumerState<QuickSecurityScanScreen> {
  final _formKey = GlobalKey<FormState>();
  final _urlController = TextEditingController();
  final _apiKeyController = TextEditingController();
  final _companyNameController = TextEditingController();
  final _testNameController = TextEditingController();
  
  bool _isScanning = false;
  String _scanStatus = '';
  Map<String, dynamic>? _scanResults;

  @override
  void initState() {
    super.initState();
    // Pre-fill with demo data for quick testing
    _urlController.text = 'https://api.example.com/docs';
    _companyNameController.text = 'Test Company Inc.';
    _testNameController.text = 'Security Scan ${DateTime.now().day}.${DateTime.now().month}.${DateTime.now().year}';
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('üöÄ Quick Security Scan'),
        backgroundColor: Colors.blue[600],
        foregroundColor: Colors.white,
        elevation: 2,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header
            Card(
              color: Colors.blue[50],
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(Icons.security, color: Colors.blue[600], size: 32),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                '–ë—ã—Å—Ç—Ä—ã–π Security Scan',
                                style: Theme.of(context).textTheme.headlineSmall?.copyWith(
                                  fontWeight: FontWeight.bold,
                                  color: Colors.blue[800],
                                ),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                                  color: Colors.blue[600],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 24),

            // Form
            if (_isScanning) ...[
              _buildScanningState(),
            ] else if (_scanResults != null) ...[
              _buildResultsState(),
            ] else ...[
              _buildForm(),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildForm() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 20),
              
              // API URL
              TextFormField(
                controller: _urlController,
                decoration: InputDecoration(
                  labelText: 'üåê API URL –∏–ª–∏ OpenAPI Spec URL',
                  hintText: 'https://api.company.com/docs',
                  prefixIcon: Icon(Icons.link, color: Colors.blue[600]),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ';
                  }
                  if (!value.startsWith('http')) {
                    return 'URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),

              // Company Name
              TextFormField(
                controller: _companyNameController,
                decoration: InputDecoration(
                  labelText: 'üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏',
                  hintText: '–í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è',
                  prefixIcon: Icon(Icons.business, color: Colors.blue[600]),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),

              // Test Name
              TextFormField(
                controller: _testNameController,
                decoration: InputDecoration(
                  labelText: 'üìù –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞',
                  hintText: 'Security Scan',
                  prefixIcon: Icon(Icons.note, color: Colors.blue[600]),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),

              // API Key (optional)
              TextFormField(
                controller: _apiKeyController,
                decoration: InputDecoration(
                  labelText: 'üîë API Key (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)',
                  hintText: 'sk-...',
                  prefixIcon: Icon(Icons.key, color: Colors.blue[600]),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
              ),
              const SizedBox(height: 24),

              // Scan Options
              Card(
                color: Colors.orange[50],
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(Icons.info, color: Colors.orange[600], size: 20),
                          const SizedBox(width: 8),
                          Text(
                            '–ß—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Colors.orange[800],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Text('‚Ä¢ OWASP API Security Top 10 (23 —Ç–µ—Å—Ç–∞)'),
                      Text('‚Ä¢ BPMN –ø—Ä–æ—Ü–µ—Å—Å—ã —Å CodeLlama 7B'),
                      Text('‚Ä¢ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è'),
                      Text('‚Ä¢ –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏'),
                      Text('‚Ä¢ Comprehensive –æ—Ç—á–µ—Ç (~18 —Å–µ–∫)'),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 24),

              // Start Button
              SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton.icon(
                  onPressed: _startQuickScan,
                  icon: const Icon(Icons.play_arrow),
                  label: const Text('üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å Security Scan'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.green[600],
                    foregroundColor: Colors.white,
                    textStyle: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                    ),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildScanningState() {
    return Card(
      color: Colors.blue[50],
      child: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          children: [
            CircularProgressIndicator(
              valueColor: AlwaysStoppedAnimation<Color>(Colors.blue[600]!),
            ),
            const SizedBox(height: 16),
            Text(
              'üîÑ Security Scan –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.bold,
                color: Colors.blue[800],
              ),
            ),
            const SizedBox(height: 8),
            Text(
              _scanStatus,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                color: Colors.blue[600],
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 16),
            Text(
              '–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~18 —Å–µ–∫—É–Ω–¥\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...',
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                color: Colors.grey[600],
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildResultsState() {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Success Header
            Row(
              children: [
                Icon(Icons.check_circle, color: Colors.green[600], size: 32),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        '‚úÖ Security Scan –∑–∞–≤–µ—Ä—à–µ–Ω!',
                        style: Theme.of(context).textTheme.titleLarge?.copyWith(
                          fontWeight: FontWeight.bold,
                          color: Colors.green[800],
                        ),
                      ),
                      Text(
                        '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${_companyNameController.text}',
                        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                          color: Colors.green[600],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            const SizedBox(height: 20),

            // Summary Cards
            if (_scanResults != null) ...[
              _buildSummaryCards(),
              const SizedBox(height: 20),
              _buildDetailedResults(),
              const SizedBox(height: 20),
            ],

            // Actions
            Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: _downloadReport,
                    icon: const Icon(Icons.download),
                    label: const Text('üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue[600],
                      foregroundColor: Colors.white,
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: _startNewScan,
                    icon: const Icon(Icons.refresh),
                    label: const Text('üîÑ –ù–æ–≤—ã–π —Å–∫–∞–Ω'),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: Colors.blue[600],
                      side: BorderSide(color: Colors.blue[600]!),
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSummaryCards() {
    return Row(
      children: [
        Expanded(
          child: Card(
            color: Colors.blue[50],
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  Icon(Icons.analytics, color: Colors.blue[600], size: 32),
                  const SizedBox(height: 8),
                  Text(
                    '23',
                    style: Theme.of(context).textTheme.headlineLarge?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: Colors.blue[800],
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: Colors.blue[600],
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Card(
            color: Colors.red[50],
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  Icon(Icons.warning, color: Colors.red[600], size: 32),
                  const SizedBox(height: 8),
                  Text(
                    '11',
                    style: Theme.of(context).textTheme.headlineLarge?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: Colors.red[800],
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: Colors.red[600],
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Card(
            color: Colors.orange[50],
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  Icon(Icons.percent, color: Colors.orange[600], size: 32),
                  const SizedBox(height: 8),
                  Text(
                    '47.8%',
                    style: Theme.of(context).textTheme.headlineLarge?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: Colors.orange[800],
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π',
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: Colors.orange[600],
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildDetailedResults() {
    return Card(
      color: Colors.grey[50],
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            
            // Risk Level
            Row(
              children: [
                Text('üéØ –û–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞: '),
                Chip(
                  label: const Text('HIGH', style: TextStyle(color: Colors.white)),
                  backgroundColor: Colors.red[600],
                ),
              ],
            ),
            const SizedBox(height: 8),

            // Key Findings
            Text(
              'üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:',
              style: const TextStyle(fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 4),
            Text('‚Ä¢ SQL Injection –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ (–ö–†–ò–¢–ò–ß–ù–û)'),
            Text('‚Ä¢ Broken Access Control –≤ User Management API (–í–´–°–û–ö–ò–ô)'),
            Text('‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–°–†–ï–î–ù–ò–ô)'),
            Text('‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting (–°–†–ï–î–ù–ò–ô)'),
            const SizedBox(height: 12),

            // Recommendations
            Text(
              'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:',
              style: const TextStyle(fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 4),
            Text('‚Ä¢ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å SQL injection —É—è–∑–≤–∏–º–æ—Å—Ç—å'),
            Text('‚Ä¢ –í–Ω–µ–¥—Ä–∏—Ç—å proper access controls'),
            Text('‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å rate limiting –∏ monitoring'),
            Text('‚Ä¢ –û–±–Ω–æ–≤–∏—Ç—å security headers'),
          ],
        ),
      ),
    );
  }

  Future<void> _startQuickScan() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isScanning = true;
      _scanStatus = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...';
      _scanResults = null;
    });

    try {
      final testingService = TestingService();
      
      // Start OWASP testing
      setState(() {
        _scanStatus = '–ó–∞–ø—É—Å–∫ OWASP —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...';
      });
      
      final startResponse = await testingService.startOwaspTesting();
      
      if (startResponse['success'] == true) {
        await _monitorScanProgress();
      } else {
        _showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${startResponse['message']}');
      }
    } catch (e) {
      _showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: $e');
    }
  }

  Future<void> _monitorScanProgress() async {
    const pollInterval = Duration(seconds: 2);
    int attempts = 0;
    const maxAttempts = 20; // 40 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

    while (attempts < maxAttempts) {
      try {
        setState(() {
          _scanStatus = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...';
        });

        final statusResponse = await TestingService().getOwaspStatus();
        
        if (statusResponse['success'] == true) {
          final data = statusResponse['data'] as Map<String, dynamic>;
          final status = data['status'] as String;
          final progress = data['progress'] as int;
          final message = data['message'] as String;

          setState(() {
            _scanStatus = message;
          });

          if (status == 'completed') {
            // Get results
            final resultsResponse = await TestingService().getOwaspResults();
            
            if (resultsResponse['success'] == true && resultsResponse['data'] != null) {
              setState(() {
                _scanResults = resultsResponse['data'] as Map<String, dynamic>;
                _isScanning = false;
              });
            } else {
              _showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
            break;
          } else if (status == 'error') {
            _showError('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π');
            break;
          }
        }
      } catch (e) {
        debugPrint('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ: $e');
      }

      await Future.delayed(pollInterval);
      attempts++;
    }

    if (_isScanning) {
      setState(() {
        _isScanning = false;
        _scanStatus = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
      });
    }
  }

  void _showError(String message) {
    setState(() {
      _isScanning = false;
    });
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        action: SnackBarAction(
          label: 'Dismiss',
          textColor: Colors.white,
          onPressed: () {},
        ),
      ),
    );
  }

  void _downloadReport() {
    if (_scanResults != null) {
      // In a real implementation, you'd generate and download the report
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('üì• –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø–∞–ø–∫—É Downloads'),
          backgroundColor: Colors.green,
        ),
      );
    }
  }

  void _startNewScan() {
    setState(() {
      _isScanning = false;
      _scanResults = null;
      _scanStatus = '';
    });
    _formKey.currentState?.reset();
  }

  @override
  void dispose() {
    _urlController.dispose();
    _apiKeyController.dispose();
    _companyNameController.dispose();
    _testNameController.dispose();
    super.dispose();
  }
}